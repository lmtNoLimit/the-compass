# Story 1.3.5: Migrate Project Structure to React Router v7 Architecture

## Status
Done

## Story
**As a** developer,  
**I want** to restructure the incorrectly implemented project to properly align with React Router v7 architecture,  
**so that** the application follows correct file-based routing patterns at the project root level (not nested in apps/web), fixing the structural issues from the premature Story 1.1 implementation.

## Acceptance Criteria
1. Project structure migrated to use `/app` directory for React Router v7
2. File-based routing implemented in `/app/routes/` directory
3. React Router configuration files created (react-router.config.ts)
4. Existing components reorganized into proper directories
5. State management configured with React Query and Zustand
6. All imports and paths updated to match new structure
7. Build configuration updated for React Router v7 compatibility
8. Application runs successfully with new structure

## Tasks / Subtasks
- [x] Create React Router v7 app structure (AC: 1, 2)
  - [x] Create `/app` directory at project root
  - [x] Create `/app/routes/` directory for file-based routing
  - [x] Create `/app/components/` directory structure (ui/, features/, layouts/)
  - [x] Create `/app/hooks/`, `/app/services/`, `/app/stores/` directories
  - [x] Create `/app/lib/` for utilities and `/app/types/` for TypeScript interfaces
- [x] Configure React Router v7 (AC: 3, 7)
  - [x] Create `react-router.config.ts` with proper configuration
  - [x] Create `/app/root.tsx` as root layout component
  - [x] Create `/app/routes.ts` for route configuration
  - [x] Update `vite.config.ts` for React Router v7 compatibility
  - [x] Configure TypeScript paths for new structure
- [x] Implement file-based routing structure (AC: 2)
  - [x] Create `/app/routes/_index.tsx` for home route
  - [x] Set up route naming patterns (e.g., briefs._index.tsx, briefs.new.tsx)
  - [x] Create placeholder routes for main features
  - [x] Implement proper route exports and loaders
- [x] Migrate existing components (AC: 4)
  - [x] Move UI components to `/app/components/ui/`
  - [x] Organize feature components in `/app/components/features/`
  - [x] Update component imports to use new paths
  - [x] Ensure Radix UI components are properly integrated
- [x] Configure state management (AC: 5)
  - [x] Install and configure React Query v5.0+
  - [x] Install and configure Zustand v4.5+
  - [x] Create example Zustand store in `/app/stores/`
  - [x] Set up React Query provider in root.tsx
  - [x] Create service layer patterns in `/app/services/`
- [x] Update authentication integration (AC: 6)
  - [x] Update Clerk integration for React Router v7
  - [x] Configure protected route patterns
  - [x] Update authentication hooks and providers
- [x] Fix import paths and references (AC: 6)
  - [x] Update all component imports to use `~/` prefix
  - [x] Fix TypeScript path aliases in tsconfig.json
  - [x] Update test imports to match new structure
  - [x] Ensure all relative imports are corrected
- [x] Verify build and runtime (AC: 7, 8)
  - [x] Run build process and fix any compilation errors
  - [x] Test development server with new structure
  - [x] Verify routing works correctly
  - [x] Ensure all existing functionality remains intact
- [x] Update tests for new structure (from testing strategy)
  - [x] Update test paths in vitest.config.ts
  - [x] Fix test imports to use new component locations
  - [x] Ensure all existing tests pass
  - [x] Add tests for new routing structure

## Dev Notes

### CRITICAL: Execution Order Issue
**This story MUST be completed BEFORE Story 1.1 can be properly implemented.**
- Story 1.1 was prematurely implemented with incorrect structure (apps/web/app/ instead of root /app/)
- This story fixes the structural issues to align with React Router v7 architecture
- After completion, Story 1.1 tasks can be re-executed on the correct structure

### Current Structure Problems (from premature 1.1 implementation):
- App directory incorrectly placed at `apps/web/app/` (monorepo pattern)
- React Router v7 expects `/app` at project root
- Prisma incorrectly located at `apps/web/prisma/schema.prisma`
- Tests incorrectly structured under `apps/web/tests/`
- Import paths and module resolution will fail with current structure

### Architecture Requirements [Source: architecture/unified-project-structure.md]
**React Router v7 Project Structure:**
```
persona-compass/
├── app/                        # React Router app directory
│   ├── routes/                 # File-based routing
│   │   ├── _index.tsx         # Home route
│   │   ├── briefs/            # Brief-related routes
│   │   │   ├── _index.tsx    # List briefs
│   │   │   ├── new.tsx       # Create new brief
│   │   │   ├── $id.tsx       # View brief
│   │   │   └── $id.edit.tsx  # Edit brief
│   │   └── validations/       # Validation routes
│   ├── components/            # Shared UI components
│   │   ├── ui/              # Radix UI primitives
│   │   ├── features/        # Feature-specific
│   │   └── layouts/         # Layout components
│   ├── hooks/                # Custom React hooks
│   ├── services/             # API service layer
│   ├── stores/               # Zustand stores
│   ├── lib/                  # Utilities
│   ├── types/                # TypeScript interfaces
│   ├── root.tsx             # Root layout
│   └── routes.ts            # Route configuration
├── react-router.config.ts    # React Router config
├── vite.config.ts           # Vite configuration
└── tsconfig.json            # TypeScript config
```

### Technology Stack [Source: architecture/tech-stack.md]
- **Frontend Framework:** React Router v7.0+ for client-side routing
- **State Management:** React Query 5.0+ (server), Zustand 4.5+ (client)
- **Build Tool:** Vite 5.0+ with React Router compatibility
- **Authentication:** Clerk React Router 5.0+ SDK
- **UI Components:** Radix UI 1.1+ with Tailwind CSS 4.0+

### File-Based Routing Patterns [Source: architecture/frontend-architecture.md]
**Route Naming Conventions:**
- `_index.tsx` - Index routes
- `$param.tsx` - Dynamic parameters
- `briefs.new.tsx` - Nested routes use dot notation
- Layout routes use `__layout` prefix

**Route Structure Example:**
```typescript
// app/routes/briefs._index.tsx
import { useLoaderData } from "react-router";
import { json } from "react-router";

export async function loader() {
  const briefs = await fetchBriefs();
  return json({ briefs });
}

export default function BriefsIndex() {
  const { briefs } = useLoaderData<typeof loader>();
  // Component implementation
}
```

### State Management Integration [Source: architecture/frontend-architecture.md#state-management]
**React Query Setup:**
```typescript
// app/root.tsx
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      cacheTime: 1000 * 60 * 10, // 10 minutes
    },
  },
});
```

**Zustand Store Pattern:**
```typescript
// app/stores/userStore.ts
import { create } from 'zustand';

interface UserStore {
  user: User | null;
  setUser: (user: User) => void;
}

export const useUserStore = create<UserStore>((set) => ({
  user: null,
  setUser: (user) => set({ user }),
}));
```

### Component Migration Notes [Source: architecture/coding-standards.md]
- Components use PascalCase: `UserProfile.tsx`
- Hooks use camelCase with 'use' prefix: `useAuth.ts`
- All async functions must have proper error handling
- Never access process.env directly - use config objects
- Import from `~/` for absolute paths within app directory

### Critical Configuration Files
**react-router.config.ts:**
```typescript
import type { Config } from "@react-router/dev/config";

export default {
  appDirectory: "app",
  buildDirectory: "build",
  future: {
    v3_fetcherPersist: true,
    v3_relativeSplatPath: true,
  },
} satisfies Config;
```

**vite.config.ts updates needed:**
```typescript
import { reactRouter } from "@react-router/dev/vite";
import { defineConfig } from "vite";

export default defineConfig({
  plugins: [reactRouter()],
  resolve: {
    alias: {
      "~": "/app",
    },
  },
});
```

### Testing
**Testing Requirements** [Source: architecture/testing-strategy.md]
- Test files location: `tests/unit/` and `tests/integration/`
- Testing framework: Vitest 1.0+
- Component tests use Testing Library
- Update test imports to use new `~/` paths
- Ensure routing tests cover file-based routes

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story creation for structure migration | Bob (Scrum Master) |
| 2025-09-05 | 2.0 | Updated as URGENT PREREQUISITE - must complete before Story 1.1 | Sarah (PO) |

## Dev Agent Record
_To be filled by Dev Agent_

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Migrated app directory from apps/web/app to /app
- Removed monorepo structure (apps/ and packages/ directories)
- Updated all configuration files for root-level React Router v7

### Completion Notes List
- Successfully migrated from monorepo structure to flat React Router v7 structure
- All dependencies merged and installed at root level
- React Query and Zustand configured and integrated
- Clerk authentication properly configured for React Router v7
- Build and dev server tested and working
- Tests updated and passing

### File List
**Created:**
- /app/root.tsx
- /app/app.css
- /app/routes/_index.tsx
- /app/routes/briefs._index.tsx
- /app/routes/briefs.new.tsx
- /app/routes/validations._index.tsx
- /app/stores/userStore.ts
- /app/services/api.ts
- /tests/unit/routes/index.test.tsx

**Modified:**
- /package.json
- /vite.config.ts
- /tsconfig.json
- /app/routes.ts

**Moved:**
- apps/web/app → /app
- apps/web/public → /public
- apps/web/tests → /tests
- apps/api/prisma → /prisma
- apps/web/app/components/*.tsx → /app/components/ui/

**Deleted:**
- /apps directory
- /packages directory
- /app/welcome directory
- /app/styles directory

## QA Results

### QA Gate Decision: **PASS** ✅
**Risk Level:** LOW  
**Reviewed:** 2025-09-05  
**Gate Decision File:** [/docs/qa/gates/1.3.5-migrate-structure.yml](../qa/gates/1.3.5-migrate-structure.yml)

### Requirements Verification
All 8 acceptance criteria have been **VERIFIED** and successfully implemented:

1. ✅ **Project Structure Migrated**: App directory successfully moved from `apps/web/app/` to root `/app/`
2. ✅ **File-Based Routing**: Proper route structure in `/app/routes/` with correct naming conventions
3. ✅ **React Router Config**: `react-router.config.ts` created with proper SSR configuration
4. ✅ **Components Reorganized**: UI components properly organized in `/app/components/ui/`
5. ✅ **State Management**: React Query and Zustand fully configured and integrated
6. ✅ **Imports Updated**: All paths use `~` alias and match new structure
7. ✅ **Build Configuration**: Vite config updated for React Router v7 compatibility
8. ✅ **Application Running**: Dev server and build process both working correctly

### Implementation Quality Assessment

**Architecture Compliance:** ✅ **COMPLIANT**
- React Router v7 structure properly implemented
- File-based routing follows recommended patterns  
- State management integration following best practices
- Authentication (Clerk) properly integrated with React Router v7

**Build & Runtime:** ✅ **WORKING**
- Dev server: `npm run dev` starts successfully on localhost:5173
- Production build: `npm run build` completes without errors
- Tests: All existing tests passing (2/2)

**Breaking Changes:** ✅ **NONE IDENTIFIED**
- Clean migration with no API changes or interface modifications
- Import paths properly updated to use `~` alias
- No conflicting dependencies or configuration issues

### Test Coverage Status
- **Basic Coverage:** ✅ Route tests exist and pass
- **Infrastructure:** ✅ Vitest properly configured  
- **Missing:** State management, API service, and authentication tests recommended for future enhancement

### Key Findings
**Strengths:**
- Complete removal of monorepo structure - no artifacts remaining
- All React Router v7 dependencies at correct versions
- Proper TypeScript configuration with path mapping
- Clean component organization and service layer patterns
- Working authentication integration with Clerk

**Recommendations for Future Enhancement:**
- Expand test coverage for Zustand stores and API services
- Add integration tests for authentication flows
- Consider adding route-level code splitting

### Final Assessment
**Overall Quality:** HIGH  
**Technical Debt:** MINIMAL  
**Maintainability:** EXCELLENT

The React Router v7 migration has been executed successfully with no blocking issues identified. The application is ready for continued development and deployment.

**QA Sign-off:** Claude Sonnet 4 - QA Agent